# Voucher Support
This service is a part of ABC Banking eco system to help customer purchase prepaid data for a SIM card by getting a voucher code from a 3rd party

## Requirements
### Functional Requirements
* Getting a voucher code from a 3rd party
* Store voucher code for future use
* Use can check all the voucher codes that they have purchased by phone number

### Non-Functional Requirements
* SLA: API will return voucher code or a message that says the request is being processed within 30 seconds
* Logging: aggregates all the logs generated by services to enable a unified view of all the events in the system

## Overall Architecture
![ABC Banking](/documents/ABC%20Banking.png)
* In scope: Voucher service and Vendor service
* Out scope: ABC website (front-end), SMS service and 3rd party service

### Services

#### ABC website
* The UI that customer can purchase prepaid data for a SIM card

#### Voucher
* Exposes API for checking all the voucher codes by phone number and return a voucher code when customer purchase prepaid data
* Keeps the key to encrypt and decrypt voucher codes that treat as sensitive data, we store encrypted voucher code to database

#### Vendor
* Exposes API for getting a voucher code from a 3rd party, if we have more vendors, we can expand this service and different vendor via vendor identity

#### SMS
* Sends a voucher code to customer when 3rd party response the code longer than 30 seconds

#### 3rd party
* Create and response a voucher code for each purchase

### Scaling
* Services is containerized and decoupling between requests, so we easily to add/remove instances under a load balancer for elastic scale

### Services communicate
* Services expose REST API and communicate via HTTP

### Security
* Services could terminal SSL for improve perfomance and require an API Gateway in the front
* If security is strictly between service, we can using HTTPS that need to configure on each service

## Project folder structure
* documents: contains all material document of this project
* vendor-service: a Spring Boot project, its contains all source code of Vendor service
* voucher-service: a Spring Boot project, its contains all source code of Voucher service
* docker-compose.yml: help to locally development
  * vendor-service: build from its Dockerfile
  * voucher-service: build from its Dockerfile and depend on mysql service
  * mysql: local database service
  * vendor-mockserver: simulating 3rd party response
* pom.xml: gathering all modules of this project

## Libraries and frameworks and tools
* Java 11
* Spring Boot v2.3.3
* Spring Data v2.3.3
* JUnit 5
* Jasypt v1.9.3
* Docker v19.03
* Docker Compose v1.25

## Start
```bash
docker-compose up -d
```

### Initial database (`voucher`), table (`voucher`) and sample data on mysql (docker)
```bash
docker exec -i mysql mysql -umyusername -pmypassword voucher < ./voucher-service/sql/initialdb.sql
```

### Mock Server: restart is required
To simulating both happy case and unhappy case, we config requests that have fixed times to call and delayed before retrurn voucher code in turn is 5 seconds and 40 seconds
So we need to restart mock server after 4 tests for endpoint: `http://localhost:1080/get-voucher-code`
How to restart mock server:
```bash
docker-compose up -d --force-recreate vendor-mockserver
```

## View
### Get all voucher code of user by phone number
```bash
curl --location --request GET 'http://localhost:8081/vouchers?phone=892754'
```

### Purchase new voucher code
```bash
curl --location --request POST 'http://localhost:8081/vouchers' \
--header 'Content-Type: application/json' \
--data-raw '{
    "phone": "892754"
}
'
```

## Stop
```bash
docker-compose down
```
